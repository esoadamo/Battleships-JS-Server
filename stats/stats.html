<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="stats.css" />
  <meta charset="utf-8">
</head>

<body>
  <div class="pageContent">
    <h1>BattleShips - results</h1>
    <table>
      <tbody id="tbody">
      </tbody>
    </table>
  </div>
  </div>

  <script>
    const refreshSeconds = 10;
    const tbody = document.querySelector('#tbody')

    function paintTable(data) {
      let rows = [];
      let headers = ['Name', 'Games', 'Wins', 'Shots fired (accuracy)', 'Shots taken (avoidance)']
      for (user of Object.keys(data)) {
        let tr = document.createElement('tr');

        function addColumn(text) {
          let td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        }

        let userData = {
          name: user,
          wins: 0,
          looses: 0,
          shotsFired: 0,
          shotsFiredHit: 0,
          shotsTaken: 0,
          shotsTakenHit: 0
        };

        Object.assign(userData, data[user]);
        tr.dataset.winPercentage = parseInt(100 * userData.wins / (userData.wins + userData.looses));

        for (let header of headers)
          switch (header) {
            case 'Name':
              addColumn(user);
              break;
            case 'Wins':
              addColumn(`${userData.wins} (${parseInt(100 * userData.wins / (userData.wins + userData.looses))}%)`);
              break;
            case 'Games':
              addColumn(`${userData.wins + userData.looses}`);
              break;
            case 'Shots fired (accuracy)':
              addColumn(`${userData.shotsFired} (${parseInt(100 * userData.shotsFiredHit / (userData.shotsFired + userData.shotsFiredHit))}%)`);
              break;
            case 'Shots taken (avoidance)':
              addColumn(`${userData.shotsTaken} (${parseInt(100 * userData.shotsTakenHit / (userData.shotsTaken + userData.shotsTakenHit))}%)`);
              break;
            default:
              addColumn('');
          }
        rows.push(tr);
      }
      tbody.innerHTML = "";
      let headerRow = document.createElement('tr');
      for (let header of headers) {
        let td = document.createElement('th');
        td.textContent = header;
        headerRow.appendChild(td);
      }
      tbody.appendChild(headerRow);
      rows.sort((a, b) => {
        return parseInt(b.dataset.winPercentage) - parseInt(a.dataset.winPercentage);
      });
      for (let row of rows)
        tbody.appendChild(row);
    }

    function fetchData() {
      console.log('Requesting');
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
          paintTable(JSON.parse(xmlHttp.responseText));
      }
      xmlHttp.open("GET", "/api/stats", true);
      xmlHttp.send(null);
    }

    paintTable({});
    fetchData();
    setInterval(fetchData, refreshSeconds * 1000);
  </script>
</body>

</html>
